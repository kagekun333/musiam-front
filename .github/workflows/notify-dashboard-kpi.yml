name: Notify dashboard to Slack (KPI Debug)

on:
  workflow_dispatch:

jobs:
  debug-posthog:
    runs-on: ubuntu-latest
    env:
      POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
      POSTHOG_HOST: ${{ secrets.POSTHOG_HOST }}
      POSTHOG_PROJECT_ID: ${{ secrets.POSTHOG_PROJECT_ID }}

    steps:
      - name: Fetch KPI raw JSON (last 24h)
        shell: bash
        run: |
          set -euo pipefail

          ph() {
            local Q="$1"
            echo "--- Running HogQL ---"
            echo "$Q"
            curl -sS -X POST \
              -H "Authorization: Bearer ${POSTHOG_API_KEY}" \
              -H "Content-Type: application/json" \
              "${POSTHOG_HOST}/api/projects/${POSTHOG_PROJECT_ID}/query" \
              --data-raw "{\"query\":{\"kind\":\"HogQLQuery\",\"query\":\"$Q\"}}"
          }

          echo "=== CTA_CLICK breakdown ==="
          ph "SELECT properties.cta AS cta, count() AS clicks
              FROM events
              WHERE event = 'CTA_CLICK' AND timestamp >= now() - INTERVAL 1 DAY
              GROUP BY cta
              ORDER BY clicks DESC"

          echo "=== ROOM_ENTER Top3 ==="
          ph "SELECT coalesce(properties.slug, properties.\$pathname, properties.pathname, properties.url) AS room,
                     count() AS enters
              FROM events
              WHERE event = 'ROOM_ENTER' AND timestamp >= now() - INTERVAL 1 DAY
              GROUP BY room
              ORDER BY enters DESC
              LIMIT 3"

          echo "=== EVENT_CARD_CLICK â†’ /events PV ratio ==="
          ph "SELECT countIf(event = 'EVENT_CARD_CLICK') AS card_clicks,
                     countIf(event = '\$pageview' AND properties.\$pathname LIKE '/events%') AS events_pv
              FROM events
              WHERE timestamp >= now() - INTERVAL 1 DAY"
